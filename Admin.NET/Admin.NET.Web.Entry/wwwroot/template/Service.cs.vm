// Admin.NET é¡¹ç›®çš„ç‰ˆæƒã€å•†æ ‡ã€ä¸“åˆ©å’Œå…¶ä»–ç›¸å…³æƒåˆ©å‡å—ç›¸åº”æ³•å¾‹æ³•è§„çš„ä¿æŠ¤ã€‚ä½¿ç”¨æœ¬é¡¹ç›®åº”éµå®ˆç›¸å…³æ³•å¾‹æ³•è§„å’Œè®¸å¯è¯çš„è¦æ±‚ã€‚
//
// æœ¬é¡¹ç›®ä¸»è¦éµå¾ª MIT è®¸å¯è¯å’Œ Apache è®¸å¯è¯ï¼ˆç‰ˆæœ¬ 2.0ï¼‰è¿›è¡Œåˆ†å‘å’Œä½¿ç”¨ã€‚è®¸å¯è¯ä½äºæºä»£ç æ ‘æ ¹ç›®å½•ä¸­çš„ LICENSE-MIT å’Œ LICENSE-APACHE æ–‡ä»¶ã€‚
//
// ä¸å¾—åˆ©ç”¨æœ¬é¡¹ç›®ä»äº‹å±å®³å›½å®¶å®‰å…¨ã€æ‰°ä¹±ç¤¾ä¼šç§©åºã€ä¾µçŠ¯ä»–äººåˆæ³•æƒç›Šç­‰æ³•å¾‹æ³•è§„ç¦æ­¢çš„æ´»åŠ¨ï¼ä»»ä½•åŸºäºæœ¬é¡¹ç›®äºŒæ¬¡å¼€å‘è€Œäº§ç”Ÿçš„ä¸€åˆ‡æ³•å¾‹çº çº·å’Œè´£ä»»ï¼Œæˆ‘ä»¬ä¸æ‰¿æ‹…ä»»ä½•è´£ä»»ï¼

using Admin.NET.Core.Service;
using Microsoft.AspNetCore.Http;
@{
    string joinTableName = "u";
    string joinTableAlias = "";
    Dictionary<string, int> definedObjects = new Dictionary<string, int>();
    bool haveLikeCdt = false;
    foreach (var column in Model.TableField){
        if (column.QueryWhether == "Y" && column.QueryType == "like"){
            haveLikeCdt = true;
        }
    }
    var hasSetStatus = Model.TableField.Any(col => col.NetType == "StatusEnum" && col.PropertyName == "Status");
    var dictTableField = Model.TableField.Where(x => x.WhetherImport == "Y" && x.EffectType == "Select") ?? default;
    var hasdictService = dictTableField.Count() > 0;
    var importField = Model.TableField.Where(x => x.WhetherImport == "Y");
    var displayColumnList = new List<string>();
}
namespace @(Model.NameSpace).Service;

/// <summary>
/// @(Model.BusName)æœåŠ¡
/// </summary>
[ApiDescriptionSettings(@(Model.ProjectLastName)Const.GroupName, Order = 100)]
public class @(Model.ClassName)Service : IDynamicApiController, ITransient
{
    private readonly SqlSugarRepository<@(Model.ClassName)> _@(Model.LowerClassName)Rep;
@if (hasdictService) {
    @:private readonly SysDictTypeService _sysDictTypeService;
}
    public @(Model.ClassName)Service(SqlSugarRepository<@(Model.ClassName)> @(Model.LowerClassName)Rep
@if (hasdictService) {
        @:,SysDictTypeService sysDictTypeService
}
    ){
        _@(Model.LowerClassName)Rep = @(Model.LowerClassName)Rep;
@if (hasdictService) {
        @:_sysDictTypeService = sysDictTypeService;
}
    }

    /// <summary>
    /// åˆ†é¡µæŸ¥è¯¢@(Model.BusName)
    /// </summary>
    /// <param name="input"></param>
    /// <returns></returns>
    [HttpPost]
    [ApiDescriptionSettings(Name = "Page")]
    [DisplayName("åˆ†é¡µæŸ¥è¯¢@(Model.BusName)")]
    public async Task<SqlSugarPagedList<@(Model.ClassName)Output>> Page(Page@(Model.ClassName)Input input)
    {
@if (haveLikeCdt) {
		@:input.Keyword = input.Keyword?.Trim();
}
        var query = _@(Model.LowerClassName)Rep.AsQueryable()
@{string conditionFlag = "";}
@if (haveLikeCdt) {
            @:.WhereIF(!string.IsNullOrEmpty(input.Keyword), u =>
    @foreach (var column in Model.TableField){
        if (column.QueryWhether == "Y" && column.QueryType == "like"){
                @:@(conditionFlag)u.@(column.PropertyName).Contains(input.Keyword)
            conditionFlag="|| ";
        }
    }
            @:)
}
@foreach (var column in Model.TableField){
if (column.QueryWhether == "Y"){
    if (column.NetType?.TrimEnd('?') == "string"){
        if(column.QueryType == "like"){
            @:.WhereIF(!string.IsNullOrWhiteSpace(input.@column.PropertyName), u => u.@(column.PropertyName).Contains(input.@(column.PropertyName).Trim()))
        }else{
            @:.WhereIF(!string.IsNullOrWhiteSpace(input.@column.PropertyName), u => u.@(column.PropertyName) @column.QueryType input.@(column.PropertyName))
        }
    }else if(column.NetType?.TrimEnd('?') == "int" || column.NetType?.TrimEnd('?') == "long"){
            @:.WhereIF(input.@column.PropertyName != null, u => u.@(column.PropertyName) @column.QueryType input.@(column.PropertyName))
    }else if(column.NetType?.TrimEnd('?') == "DateTime" && column.QueryType == "~"){
            @:.WhereIF(input.@(column.PropertyName)Range != null && input.@(column.PropertyName)Range.Length == 2, u => u.@(column.PropertyName) >= input.@(column.PropertyName)Range[0] && u.@(column.PropertyName) <= input.@(column.PropertyName)Range[1])
    }else if(column.NetType?.TrimEnd('?').EndsWith("Enum") == true) {
            @:.WhereIF(input.@(column.PropertyName).HasValue, u => u.@(column.PropertyName) @column.QueryType input.@(column.PropertyName))
    }
} 
}
@if(Model.IsJoinTable){
            @:// å¤„ç†å¤–é”®å’ŒTreeSelectorç›¸å…³å­—æ®µçš„è¿æ¥
    @foreach (var column in Model.TableField.Where(u => u.EffectType == "fk" || u.EffectType == "ApiTreeSelect")){
            joinTableAlias = Regex.Replace(column.LowerPropertyName, "[iI]d$", "");
            joinTableName += ", " + joinTableAlias;
            @:.LeftJoin<@column.FkEntityName>((@joinTableName) => u.@(column.PropertyName) == @joinTableAlias.@(column.EffectType == "fk" ? column.FkLinkColumnName : column.ValueColumn))
    }
            @:.Select((@joinTableName) => new @(Model.ClassName)Output
            @:{
@foreach (var column in Model.TableField){
                joinTableAlias = Regex.Replace(column.LowerPropertyName, "[iI]d$", "");
                if(column.EffectType == "fk"){
                @:@(column.PropertyName) = u.@(column.PropertyName), 
                @:@(column.PropertyName)@(column.FkColumnName) = @(joinTableAlias).@(column.FkColumnName),
                } else if(column.EffectType == "ApiTreeSelect"){
                displayColumnList = column.DisplayColumn.Split(",").Select(u => $"{{{joinTableAlias}.{u}}}").ToList();
                @:@(column.PropertyName) = u.@(column.PropertyName),  
                @:@(column.PropertyName)Display = $"@(string.Join("-", displayColumnList))",
                } else if(column.NetType?.TrimEnd('?').EndsWith("Enum") == true){
                @:@(column.PropertyName) = u.@(column.PropertyName),
                } else {
                @:@(column.PropertyName) = u.@(column.PropertyName),
                }
}
            @:});
@foreach (var column in Model.TableField){
    if(column.EffectType == "fk"){   
 
    }else if(column.EffectType == "Upload"){
            @://.Mapper(c => c.@(column.PropertyName)Attachment, c => c.@(column.PropertyName))
    }
}
} else {
            @:.Select<@(Model.ClassName)Output>();
}
		return await query.OrderBuilder(input).ToPagedListAsync(input.Page, input.PageSize);
    }

    /// <summary>
    /// å¢åŠ @(Model.BusName)
    /// </summary>
    /// <param name="input"></param>
    /// <returns></returns>
    [HttpPost]
    [ApiDescriptionSettings(Name = "Add")]
    [DisplayName("å¢åŠ @(Model.BusName)")]
    public async Task<long> Add(Add@(Model.ClassName)Input input)
    {
        var entity = input.Adapt<@(Model.ClassName)>();
        await _@(Model.LowerClassName)Rep.InsertAsync(entity);
        return entity.Id;
    }

    /// <summary>
    /// åˆ é™¤@(Model.BusName)
    /// </summary>
    /// <param name="input"></param>
    /// <returns></returns>
    [HttpPost]
    [ApiDescriptionSettings(Name = "Delete")]
    [DisplayName("åˆ é™¤@(Model.BusName)")]
    public async Task Delete(Delete@(Model.ClassName)Input input)
    {
@foreach (var column in Model.TableField.Where(u => u.ColumnKey == "True")){
        @:var entity = await _@(Model.LowerClassName)Rep.GetFirstAsync(u => u.@(column.PropertyName) == input.@(column.PropertyName)) ?? throw Oops.Oh(ErrorCodeEnum.D1002);
}
        await _@(Model.LowerClassName)Rep.FakeDeleteAsync(entity);   //å‡åˆ é™¤
        //await _@(Model.LowerClassName)Rep.DeleteAsync(entity);   //çœŸåˆ é™¤
    }

    /// <summary>
    /// æ‰¹é‡åˆ é™¤@(Model.BusName)
    /// </summary>
    /// <param name="input"></param>
    /// <returns></returns>
    [HttpPost]
    [ApiDescriptionSettings(Name = "BatchDelete")]
    [DisplayName("æ‰¹é‡åˆ é™¤@(Model.BusName)")]
    public async Task<int> BatchDelete(BatchDelete@(Model.ClassName)Input input)
    {
@foreach (var column in Model.TableField.Where(u => u.ColumnKey == "True")){
        @:var list = await _@(Model.LowerClassName)Rep.AsQueryable().Where(u => input.@(column.PropertyName)List.Contains(u.@(column.PropertyName))).ToListAsync() ?? throw Oops.Oh(ErrorCodeEnum.D1002);
}
        return await _@(Model.LowerClassName)Rep.FakeDeleteAsync(list);   //å‡åˆ é™¤
        //return await _@(Model.LowerClassName)Rep.DeleteAsync(list);   //çœŸåˆ é™¤
    }

    /// <summary>
    /// æ›´æ–°@(Model.BusName)
    /// </summary>
    /// <param name="input"></param>
    /// <returns></returns>
    [HttpPost]
    [ApiDescriptionSettings(Name = "Update")]
    [DisplayName("æ›´æ–°@(Model.BusName)")]
    public async Task Update(Update@(Model.ClassName)Input input)
    {
        var entity = input.Adapt<@(Model.ClassName)>();
        await _@(Model.LowerClassName)Rep.AsUpdateable(entity).IgnoreColumns(ignoreAllNullColumns: true).ExecuteCommandAsync();
    }
@if (hasSetStatus) {
@:
    @:/// <summary>
    @:/// è®¾ç½®@(Model.BusName)çŠ¶æ€
    @:/// </summary>
    @:/// <param name="input"></param>
    @:/// <returns></returns>
    @:[ApiDescriptionSettings(Name = "SetStatus"), HttpPost]
    @:[DisplayName("è®¾ç½®@(Model.BusName)çŠ¶æ€")]
    @:public async Task SetStatus(BaseStatusInput input)
    @:{
        @:await _@(Model.LowerClassName)Rep.AsUpdateable().SetColumns(u => u.Status, input.Status).Where(u => u.Id == input.Id).ExecuteCommandAsync();
    @:} 
}

    /// <summary>
    /// è·å–@(Model.BusName)
    /// </summary>
    /// <param name="input"></param>
    /// <returns></returns>
    [HttpGet]
    [ApiDescriptionSettings(Name = "Detail")]
    [DisplayName("è·å–@(Model.BusName)")]
    public async Task<@(Model.ClassName)> Detail([FromQuery] QueryById@(Model.ClassName)Input input)
    {
@foreach (var column in Model.TableField){
if (@column.ColumnKey == "True"){
        @:return await _@(Model.LowerClassName)Rep.GetFirstAsync(u => u.@(column.PropertyName) == input.@(column.PropertyName));
}   
}            
    }

    /// <summary>
    /// è·å–@(Model.BusName)åˆ—è¡¨
    /// </summary>
    /// <param name="input"></param>
    /// <returns></returns>
    [HttpGet]
    [ApiDescriptionSettings(Name = "List")]
    [DisplayName("è·å–@(Model.BusName)åˆ—è¡¨")]
    public async Task<List<@(Model.ClassName)Output>> List([FromQuery] Page@(Model.ClassName)Input input)
    {
        return await _@(Model.LowerClassName)Rep.AsQueryable().Select<@(Model.ClassName)Output>().ToListAsync();
    }
@foreach (var column in Model.TableField){
if(column.EffectType == "fk" && (@column.WhetherAddUpdate == "Y" || column.QueryWhether == "Y")){
@:
    @:/// <summary>
    @:/// è·å–@(column.ColumnComment)åˆ—è¡¨
    @:/// </summary>
    @:/// <returns></returns>
    @:[ApiDescriptionSettings(Name = "@(column.FkEntityName)@(column.PropertyName)Dropdown"), HttpGet]
    @:[DisplayName("è·å–@(column.ColumnComment)åˆ—è¡¨")]
    @:public async Task<dynamic> @(column.FkEntityName)@(column.PropertyName)Dropdown()
    @:{
        @:return await _@(Model.LowerClassName)Rep.Context.Queryable<@(column.FkEntityName)>().Select(u => new
            @:{
                @:Label = u.@(column.FkColumnName),
                @:Value = u.@(column.FkLinkColumnName)
            @:}
        @:).ToListAsync();
    @:}
}
}
@foreach (var column in Model.TableField){
if(column.EffectType == "Upload"){
@:
    @:/// <summary>
    @:/// ä¸Šä¼ @(column.ColumnComment)
    @:/// </summary>
    @:/// <param name="file"></param>
    @:/// <returns></returns>
    @:[ApiDescriptionSettings(Name = "Upload@(column.PropertyName)"), HttpPost]
    @:[DisplayName("ä¸Šä¼ @(column.ColumnComment)")]
    @:public async Task<SysFile> Upload@(column.PropertyName)([Required] IFormFile file)
    @:{
            @:var service = App.GetRequiredService<SysFileService>();
            @:return await service.UploadFile(new FileUploadInput { File = file, Path = "upload/@(column.PropertyName)" }); 
    @:} 
}
}
@foreach (var column in Model.TableField){
if(column.EffectType == "ApiTreeSelect" && !definedObjects.ContainsKey("@(column.FkEntityName)Tree")){
@:
    definedObjects.Add("@(column.FkEntityName)Tree", 1);
    @:/// <summary>
    @:/// è·å–@(column.ColumnComment)é€‰æ‹©æ•°æ®
    @:/// </summary>
    @:[ApiDescriptionSettings(Name = "@(column.FkEntityName)Tree")]
    @:[DisplayName("è·å–@(column.ColumnComment)é€‰æ‹©æ•°æ®")]
    @:public async Task<List<@(column.FkEntityName)TreeOutput>> @(column.FkEntityName)Tree()
    @:{
        displayColumnList = column.DisplayColumn.Split(",").Select(u => $"{{u.{u}}}").ToList();
        @:return await _@(Model.LowerClassName)Rep.Context.Queryable<@(column.FkEntityName)>().Select(u => new @(column.FkEntityName)TreeOutput {
            @:Label = $"@(string.Join("-", displayColumnList))",
            @:Value = u.@column.ValueColumn
        @:}, true).ToTreeAsync(u => u.Children, u => u.@(column.PidColumn), @(column.WhetherRequired == "Y" ? "0" : "null"));
    @:}
}
}
@if (hasdictService) {
@:
    @:/// <summary>
    @:/// è·å–å­—å…¸æ–‡æœ¬åˆ—è¡¨
    @:/// </summary>
    @:/// <param name="dictTypeCode"></param>
    @:/// <returns></returns>
    @:private List<string> GetDictDataTextList(string dictTypeCode)
    @:{
    @:    return _sysDictTypeService.GetDataList(new GetDataDictTypeInput { Code = dictTypeCode }).Result?.Select(x => x.Value).ToList();
    @:}
}
@if (importField?.Count() > 0) {
@:
    @:/// <summary>
    @:/// ä¸‹è½½@(Model.BusName)æ•°æ®å¯¼å…¥æ¨¡æ¿
    @:/// </summary>
    @:/// <returns></returns>
    @:[DisplayName("ä¸‹è½½@(Model.BusName)æ•°æ®å¯¼å…¥æ¨¡æ¿")]
    @:[ApiDescriptionSettings(Name = "Import"), HttpGet, NonUnify]
    @:public IActionResult DownloadTemplate()
    @:{
        @:return ExcelHelper.ExportTemplate(new List<Export@(Model.ClassName)Output>(), "@(Model.BusName)å¯¼å…¥æ¨¡æ¿");
    @:}
@:
    @:/// <summary>
    @:/// å¯¼å…¥@(Model.BusName)è®°å½• ğŸ“ƒ
    @:/// </summary>
    @:/// <returns></returns>
    @:[DisplayName("å¯¼å…¥@(Model.BusName)è®°å½•")]
    @:[ApiDescriptionSettings(Name = "Import"), HttpPost, NonUnify, UnitOfWork]
    @:public IActionResult ImportData([Required] IFormFile file)
    @:{
        @:lock (this)
        @:{
            foreach (var column in dictTableField){
            @:var @(@column.LowerPropertyName)DictMap = _sysDictTypeService.GetDataList(new GetDataDictTypeInput { Code = "@(@column.DictTypeCode)" }).Result.ToDictionary(x => x.Value, x => x.Code);
            }
            @:var stream = ExcelHelper.ImportData<Import@(@Model.ClassName)Input, @(@Model.ClassName)>(file, (list, markerErrorAction) =>
            @:{
                @:_@(@Model.LowerClassName)Rep.Context.Utilities.PageEach(list, 2048, pageItems =>
                @:{
                    @:// æ ¡éªŒå¹¶è¿‡æ»¤å¿…å¡«åŸºæœ¬ç±»å‹ä¸ºnullçš„å­—æ®µ
                    @:var rows = pageItems.Where(x => {
                        foreach (var column in importField.Where(x => x.WhetherRequired == "Y" && Regex.IsMatch(x.NetType, "(int|long|double|float|bool|Enum[?]?)"))){
                        @:if (x.@(@column.PropertyName) == null){
                            @:x.Error = "@(@column.ColumnComment)ä¸èƒ½ä¸ºç©º";
                            @:return false;
                        @:}
                        }
                        @:return true;
                    @:}).Adapt<List<@(@Model.ClassName)>>();
                    if (hasdictService){
                    @:// æ˜ å°„å­—å…¸å€¼
                    @:foreach(var row in rows){
                        foreach (var column in dictTableField){
                        @:row.@(@column.PropertyName) = @(@column.LowerPropertyName)DictMap.GetValueOrDefault(row.@(@column.PropertyName) ?? "");
                        }
                    @:}
                    }
                    @:var storageable = _@(@Model.LowerClassName)Rep.Context.Storageable(rows)
                        foreach (var column in importField){
                        if (@column.WhetherRequired == "Y"){
                        if(column.NetType.TrimEnd('?') == "string"){
                        @:.SplitError(it => string.IsNullOrWhiteSpace(it.Item.@(@column.PropertyName)), "@(@column.ColumnComment)ä¸èƒ½ä¸ºç©º")
                        } else if(column.NetType.EndsWith('?') == true){
                        @:.SplitError(it => it.Item.@(@column.PropertyName) == null, "@(@column.ColumnComment)ä¸èƒ½ä¸ºç©º")
                        }}
                        if (@column.NetType?.TrimEnd('?') == "string"){
                        @:.SplitError(it => it.Item.@(@column.PropertyName)?.Length > @column.ColumnLength, "@(@column.ColumnComment)é•¿åº¦ä¸èƒ½è¶…è¿‡@(@column.ColumnLength)ä¸ªå­—ç¬¦")
                        }}
                        @:.ToStorage();

                    @:storageable.BulkCopy();
                    @:storageable.BulkUpdate();
                    
                    @:markerErrorAction.Invoke(storageable, pageItems, rows);
                @:});
            @:});
@:
            @:return stream;
        @:}
    @:}
}
@}
