// Admin.NET é¡¹ç›®çš„ç‰ˆæƒã€å•†æ ‡ã€ä¸“åˆ©å’Œå…¶ä»–ç›¸å…³æƒåˆ©å‡å—ç›¸åº”æ³•å¾‹æ³•è§„çš„ä¿æŠ¤ã€‚ä½¿ç”¨æœ¬é¡¹ç›®åº”éµå®ˆç›¸å…³æ³•å¾‹æ³•è§„å’Œè®¸å¯è¯çš„è¦æ±‚ã€‚
//
// æœ¬é¡¹ç›®ä¸»è¦éµå¾ª MIT è®¸å¯è¯å’Œ Apache è®¸å¯è¯ï¼ˆç‰ˆæœ¬ 2.0ï¼‰è¿›è¡Œåˆ†å‘å’Œä½¿ç”¨ã€‚è®¸å¯è¯ä½äºæºä»£ç æ ‘æ ¹ç›®å½•ä¸­çš„ LICENSE-MIT å’Œ LICENSE-APACHE æ–‡ä»¶ã€‚
//
// ä¸å¾—åˆ©ç”¨æœ¬é¡¹ç›®ä»äº‹å±å®³å›½å®¶å®‰å…¨ã€æ‰°ä¹±ç¤¾ä¼šç§©åºã€ä¾µçŠ¯ä»–äººåˆæ³•æƒç›Šç­‰æ³•å¾‹æ³•è§„ç¦æ­¢çš„æ´»åŠ¨ï¼ä»»ä½•åŸºäºæœ¬é¡¹ç›®äºŒæ¬¡å¼€å‘è€Œäº§ç”Ÿçš„ä¸€åˆ‡æ³•å¾‹çº çº·å’Œè´£ä»»ï¼Œæˆ‘ä»¬ä¸æ‰¿æ‹…ä»»ä½•è´£ä»»ï¼

using Admin.NET.Core.Service;
using Microsoft.AspNetCore.Http;
@{
    string LowerFirstLetter(string text) => text.ToString()[..1].ToLower() + text[1..];

    var primaryKey = Model.TableField.First(u => u.ColumnKey == "True");
    var importFields = Model.TableField.Where(x => x.WhetherImport == "Y");

    var injectServices = new List<string>();
    if (Model.TableField.Any(u => u.EffectType == "Upload")) injectServices.Add("SysFileService");
    if (Model.TableField.Any(x => x.WhetherImport == "Y" && x.EffectType == "Select")) injectServices.Add("SysDictTypeService");
}
namespace @(Model.NameSpace);

/// <summary>
/// @(Model.BusName)æœåŠ¡ ğŸ§©
/// </summary>
[ApiDescriptionSettings(@(Model.ProjectLastName)Const.GroupName, Order = 100)]
public class @(Model.ClassName)Service : IDynamicApiController, ITransient
{
    private readonly SqlSugarRepository<@(Model.ClassName)> _@(Model.LowerClassName)Rep;
    @foreach(var name in injectServices) {
    @:private readonly @name _@(LowerFirstLetter(name));
    }

    public @(Model.ClassName)Service(SqlSugarRepository<@(Model.ClassName)> @(Model.LowerClassName)Rep@(injectServices.Count > 0 ? ", " + string.Join(", ", injectServices.Select(name => $"{name} {LowerFirstLetter(name)}")) : ""))
    {
        _@(Model.LowerClassName)Rep = @(Model.LowerClassName)Rep;
        @foreach(var name in injectServices) {
        @:_@LowerFirstLetter(name) = @LowerFirstLetter(name);
        }
    }

    /// <summary>
    /// åˆ†é¡µæŸ¥è¯¢@(Model.BusName) ğŸ”–
    /// </summary>
    /// <param name="input"></param>
    /// <returns></returns>
    [DisplayName("åˆ†é¡µæŸ¥è¯¢@(Model.BusName)")]
    [ApiDescriptionSettings(Name = "Page"), HttpPost]
    public async Task<SqlSugarPagedList<@(Model.ClassName)Output>> Page(Page@(Model.ClassName)Input input)
    {
        input.Keyword = input.Keyword?.Trim();
        var query = _@(Model.LowerClassName)Rep.AsQueryable()
@{
          string joinTableName = "u";
          var queryFields = Model.TableField.Where(u => u.QueryWhether == "Y");
          // å…³é”®å­—æ¨¡ç³ŠæŸ¥è¯¢
          if (queryFields.Any(u => u.QueryType == "like")) {
            @:.WhereIF(!string.IsNullOrEmpty(input.Keyword), u => @string.Join(" || ", queryFields.Where(u => u.QueryType == "like").Select(col => $"u.{col.PropertyName}.Contains(input.Keyword)")))
          }
          // å­—æ®µç»„åˆæŸ¥è¯¢
          foreach(var column in queryFields) {
            if (column.NetType.TrimEnd('?') == "string") {
            @:.WhereIF(!string.IsNullOrWhiteSpace(input.@(column.PropertyName)), u => u.@(column.PropertyName)@(column.QueryType == "like" ? $".Contains(input.{column.PropertyName}.Trim())" : $" {column.QueryType} input.{column.PropertyName}.Trim()"))
            } else if (column.NetType.TrimEnd('?') == "int" || column.NetType.TrimEnd('?') == "long") {
            @:.WhereIF(input.@(column.PropertyName) != null, u => u.@(column.PropertyName) @(column.QueryType) input.@(column.PropertyName))
            } else if (column.NetType.TrimEnd('?').EndsWith("Enum")) {
            @:.WhereIF(input.@(column.PropertyName).HasValue, u => u.@(column.PropertyName) == input.@(column.PropertyName))
            } else if (column.NetType.TrimEnd('?') == "DateTime" && column.QueryType == "~") {
            @:.WhereIF(input.@(column.PropertyName)Range?.Length == 2, u => u.@(column.PropertyName) >= input.@(column.PropertyName)Range[0] && u.@(column.PropertyName) <= input.@(column.PropertyName)Range[1])
            }
          }
          // è”è¡¨
          if (Model.IsJoinTable) {
            @foreach (var column in Model.TableField.Where(u => u.EffectType == "fk" || u.EffectType == "ApiTreeSelect")){
            var joinTableAlias = Regex.Replace(column.LowerPropertyName, "[iI]d$", "");
            joinTableName += ", " + joinTableAlias;
            @:.LeftJoin<@column.FkEntityName>((@joinTableName) => u.@(column.PropertyName) == @joinTableAlias.@(column.EffectType == "fk" ? column.FkLinkColumnName : column.ValueColumn))
          }
            // æŸ¥è¯¢åˆ—è¡¨
            @:.Select((@joinTableName) => new @(Model.ClassName)Output
            @:{
            foreach (var column in Model.TableField) {
                var joinTableAlias = Regex.Replace(column.LowerPropertyName, "[iI]d$", "");
                if (column.EffectType == "fk") {
                var columnList = column.FkColumnName.Split(",").Select(n => $"{{{joinTableAlias}.{n}}}").ToList();
                @:@(column.PropertyName) = u.@(column.PropertyName), 
                @:@(column.PropertyName)FkColumn = $"@(string.Join("-", columnList))",
                } else if (column.EffectType == "ApiTreeSelect") {
                var columnList = column.DisplayColumn.Split(",").Select(n => $"{{{joinTableAlias}.{n}}}").ToList();
                @:@(column.PropertyName) = u.@(column.PropertyName),  
                @:@(column.PropertyName)Display = $"@(string.Join("-", columnList))",
                } else {
                @:@(column.PropertyName) = u.@(column.PropertyName),
                }
            }
            @:});
         } else {
            // æ— è”è¡¨
            @:.Select<@(Model.ClassName)Output>();
         }
}
		return await query.OrderBuilder(input).ToPagedListAsync(input.Page, input.PageSize);
    }

    /// <summary>
    /// å¢åŠ @(Model.BusName) â•
    /// </summary>
    /// <param name="input"></param>
    /// <returns></returns>
    [DisplayName("å¢åŠ @(Model.BusName)")]
    [ApiDescriptionSettings(Name = "Add"), HttpPost]
    public async Task<long> Add(Add@(Model.ClassName)Input input)
    {
        var entity = input.Adapt<@(Model.ClassName)>();
        return await _@(Model.LowerClassName)Rep.InsertAsync(entity) ? entity.Id : 0;
    }

    /// <summary>
    /// åˆ é™¤@(Model.BusName) âŒ
    /// </summary>
    /// <param name="input"></param>
    /// <returns></returns>
    [DisplayName("åˆ é™¤@(Model.BusName)")]
    [ApiDescriptionSettings(Name = "Delete"), HttpPost]
    public async Task Delete(Delete@(Model.ClassName)Input input)
    {
        @foreach (var column in Model.TableField.Where(u => u.ColumnKey == "True")) {
        @:var entity = await _@(Model.LowerClassName)Rep.GetFirstAsync(u => u.@(column.PropertyName) == input.@(column.PropertyName)) ?? throw Oops.Oh(ErrorCodeEnum.D1002);
        }
        await _@(Model.LowerClassName)Rep.FakeDeleteAsync(entity);   //å‡åˆ é™¤
        //await _@(Model.LowerClassName)Rep.DeleteAsync(entity);   //çœŸåˆ é™¤
    }

    /// <summary>
    /// æ‰¹é‡åˆ é™¤@(Model.BusName) âŒ
    /// </summary>
    /// <param name="input"></param>
    /// <returns></returns>
    [DisplayName("æ‰¹é‡åˆ é™¤@(Model.BusName)")]
    [ApiDescriptionSettings(Name = "BatchDelete"), HttpPost]
    public async Task<int> BatchDelete(BatchDelete@(Model.ClassName)Input input)
    {
        @foreach (var column in Model.TableField.Where(u => u.ColumnKey == "True")) {
        @:var list = await _@(Model.LowerClassName)Rep.AsQueryable().Where(u => input.@(column.PropertyName)List.Contains(u.@(column.PropertyName))).ToListAsync() ?? throw Oops.Oh(ErrorCodeEnum.D1002);
        }
        return await _@(Model.LowerClassName)Rep.FakeDeleteAsync(list);   //å‡åˆ é™¤
        //return await _@(Model.LowerClassName)Rep.DeleteAsync(list);   //çœŸåˆ é™¤
    }

    /// <summary>
    /// æ›´æ–°@(Model.BusName) âœï¸
    /// </summary>
    /// <param name="input"></param>
    /// <returns></returns>
    [DisplayName("æ›´æ–°@(Model.BusName)")]
    [ApiDescriptionSettings(Name = "Update"), HttpPost]
    public async Task Update(Update@(Model.ClassName)Input input)
    {
        var entity = input.Adapt<@(Model.ClassName)>();
        await _@(Model.LowerClassName)Rep.AsUpdateable(entity).IgnoreColumns(ignoreAllNullColumns: true).ExecuteCommandAsync();
    }
    @if (Model.TableField.Any(col => col.NetType == "StatusEnum" && col.PropertyName == "Status")) {
    @:
    @:/// <summary>
    @:/// è®¾ç½®@(Model.BusName)çŠ¶æ€ ğŸš«
    @:/// </summary>
    @:/// <param name="input"></param>
    @:/// <returns></returns>
    @:[DisplayName("è®¾ç½®@(Model.BusName)çŠ¶æ€")]
    @:[ApiDescriptionSettings(Name = "SetStatus"), HttpPost]
    @:public async Task Set@(Model.ClassName)Status(BaseStatusInput input)
    @:{
        @:await _@(Model.LowerClassName)Rep.AsUpdateable().SetColumns(u => u.Status, input.Status).Where(u => u.Id == input.Id).ExecuteCommandAsync();
    @:} 
    }

    /// <summary>
    /// è·å–@(Model.BusName)è¯¦æƒ… â„¹ï¸
    /// </summary>
    /// <param name="input"></param>
    /// <returns></returns>
    [DisplayName("è·å–@(Model.BusName)è¯¦æƒ…")]
    [ApiDescriptionSettings(Name = "Detail"), HttpGet]
    public async Task<@(Model.ClassName)> Detail([FromQuery] QueryById@(Model.ClassName)Input input)
    {
        return await _@(Model.LowerClassName)Rep.GetFirstAsync(u => u.@(primaryKey.PropertyName) == input.@(primaryKey.PropertyName));
    }

    /// <summary>
    /// è·å–@(Model.BusName)åˆ—è¡¨ ğŸ”–
    /// </summary>
    /// <param name="input"></param>
    /// <returns></returns>
    [DisplayName("è·å–@(Model.BusName)åˆ—è¡¨")]
    [ApiDescriptionSettings(Name = "List"), HttpGet]
    public async Task<List<@(Model.ClassName)Output>> List([FromQuery] Page@(Model.ClassName)Input input)
    {
        return await _@(Model.LowerClassName)Rep.AsQueryable().Select<@(Model.ClassName)Output>().ToListAsync();
    }
@foreach (var column in Model.TableField.Where(u => u.EffectType == "fk" && (u.WhetherAddUpdate == "Y" || u.QueryWhether == "Y"))){
@:
    var dropdownName = $"{column.FkEntityName}{Regex.Replace(column.PropertyName, "[iI]d$", "")}Dropdown";
    @:/// <summary>
    @:/// è·å–@(column.ColumnComment)åˆ—è¡¨ ğŸ”–
    @:/// </summary>
    @:/// <returns></returns>
    @:[DisplayName("è·å–@(column.ColumnComment)åˆ—è¡¨")]
    @:[ApiDescriptionSettings(Name = "@(dropdownName)"), HttpGet]
    @:public async Task<dynamic> @(dropdownName)([FromQuery]bool all)
    @:{
        var columnList = column.FkColumnName.Split(",").Select(name => $"{{u.{name}}}").ToList();
        @:return await _@(Model.LowerClassName)Rep.Context.Queryable<@(column.FkEntityName)>()
            @:.InnerJoinIF<@Model.ClassName>(!all, (u, r) => u.@(column.FkLinkColumnName) == r.@(column.PropertyName))
            @:.Select(u => new
            @:{
                @:Label = $"@(string.Join("-", columnList))",
                @:Value = u.@(column.FkLinkColumnName)
            @:}
        @:).ToListAsync();
    @:}
}
@{
var definedObjects = new Dictionary<string, object>();
@foreach (var column in Model.TableField.Where(u => u.EffectType == "ApiTreeSelect" && !definedObjects.ContainsKey("@(u.FkEntityName)Tree"))){
@:
    definedObjects.Add("@(column.FkEntityName)Tree", 1);
    @:/// <summary>
    @:/// è·å–@(column.ColumnComment)é€‰æ‹©æ•°æ® ğŸ”–
    @:/// </summary>
    @:[DisplayName("è·å–@(column.ColumnComment)é€‰æ‹©æ•°æ®")]
    @:[ApiDescriptionSettings(Name = "@(column.FkEntityName)Tree"), HttpGet]
    @:public async Task<List<@(column.FkEntityName)TreeOutput>> @(column.FkEntityName)Tree([FromQuery]bool all)
    @:{
        var columnList = column.DisplayColumn.Split(",").Select(name => $"{{u.{name}}}").ToList();
        @:return await _@(Model.LowerClassName)Rep.Context.Queryable<@column.FkEntityName>()
          @:.InnerJoinIF<@Model.ClassName>(!all, (u, r) => u.@(column.ValueColumn) == r.@(column.PropertyName))
          @:.Select(u => new @(column.FkEntityName)TreeOutput {
            @:Label = $"@(string.Join("-", columnList))",
            @:Value = u.@column.ValueColumn
        @:}, true).ToTreeAsync(u => u.Children, u => u.@column.PidColumn, @(column.WhetherRequired == "Y" ? "0" : "null"));
    @:}
}
}
@foreach (var column in Model.TableField.Where(u => u.EffectType == "Upload")) {
@:
    @:/// <summary>
    @:/// ä¸Šä¼ @(column.ColumnComment) â¬†ï¸
    @:/// </summary>
    @:/// <param name="file"></param>
    @:/// <returns></returns>
    @:[DisplayName("ä¸Šä¼ @(column.ColumnComment)")]
    @:[ApiDescriptionSettings(Name = "Upload@(column.PropertyName)"), HttpPost]
    @:public async Task<SysFile> Upload@(column.PropertyName)([Required] IFormFile file)
    @:{
        @:return await _sysFileService.UploadFile(new FileUploadInput { File = file, SavePath = "upload/@(Model.ClassName)/@(column.PropertyName)" }); 
    @:}
}
@if (importFields.Count() > 0) {
@:
    @:/// <summary>
    @:/// ä¸‹è½½@(Model.BusName)æ•°æ®å¯¼å…¥æ¨¡æ¿ â¬‡ï¸
    @:/// </summary>
    @:/// <returns></returns>
    @:[DisplayName("ä¸‹è½½@(Model.BusName)æ•°æ®å¯¼å…¥æ¨¡æ¿")]
    @:[ApiDescriptionSettings(Name = "Import"), HttpGet, NonUnify]
    @:public IActionResult DownloadTemplate()
    @:{
        var fieldsList = importFields.Where(u => u.EffectType == "fk" || u.EffectType == "ApiTreeSelect").ToList();
        if (fieldsList.Any()) {
        @:return ExcelHelper.ExportTemplate(new List<Export@(Model.ClassName)Output>(), "@(Model.BusName)å¯¼å…¥æ¨¡æ¿", (_, info) =>
        @:{
            foreach (var column in fieldsList) {
            var columnList = (column.EffectType == "fk" ? column.FkColumnName : column.DisplayColumn).Split(",").Select(n => $"{{u.{n}}}").ToList();
            @:if (nameof(Export@(Model.ClassName)Output.@(column.PropertyName)Label) == info.Name) return _@(Model.LowerClassName)Rep.Context.Queryable<@(column.FkEntityName)>().Select(u => $"@(string.Join("-", columnList))").Distinct().ToList();
            }
            @:return null;
        @:});
        } else {
        @:return ExcelHelper.ExportTemplate(new List<Export@(Model.ClassName)Output>(), "@(Model.BusName)å¯¼å…¥æ¨¡æ¿");
        }
    @:}
@:
    @:/// <summary>
    @:/// å¯¼å…¥@(Model.BusName)è®°å½• ğŸ’¾
    @:/// </summary>
    @:/// <returns></returns>
    @:[DisplayName("å¯¼å…¥@(Model.BusName)è®°å½•")]
    @:[ApiDescriptionSettings(Name = "Import"), HttpPost, NonUnify, UnitOfWork]
    @:public IActionResult ImportData([Required] IFormFile file)
    @:{
        @:lock (this)
        @:{
            var dictTableField = Model.TableField.Where(x => x.WhetherImport == "Y" && x.EffectType == "Select") ?? default;
            foreach (var column in dictTableField){
            @:var @(column.LowerPropertyName)DictMap = _sysDictTypeService.GetDataList(new GetDataDictTypeInput { Code = "@(column.DictTypeCode)" }).Result.ToDictionary(x => x.Value, x => x.Code);
            }

            @:var stream = ExcelHelper.ImportData<Import@(Model.ClassName)Input, @(Model.ClassName)>(file, (list, markerErrorAction) =>
            @:{
                @:_@(Model.LowerClassName)Rep.Context.Utilities.PageEach(list, 2048, pageItems =>
                @:{
                    foreach (var column in importFields.Where(u => u.EffectType == "fk" || u.EffectType == "ApiTreeSelect")) {
                    @:// é“¾æ¥ @(column.ColumnComment)
                    @:var @(column.LowerPropertyName)LabelList = pageItems.Where(x => x.@(column.PropertyName)Label != null).Select(x => x.@(column.PropertyName)Label).Distinct().ToList();
                    @:if (@(column.LowerPropertyName)LabelList.Any()) {
                        var valueColumn = column.EffectType == "fk" ? column.FkLinkColumnName : column.ValueColumn;
                        var columnList = (column.EffectType == "fk" ? column.FkColumnName : column.DisplayColumn).Split(",").Select(n => $"{{u.{n}}}").ToList();
                        @:var @(column.LowerPropertyName)LinkMap = _@(Model.LowerClassName)Rep.Context.Queryable<@(column.FkEntityName)>().Where(u => @(column.LowerPropertyName)LabelList.Contains($"@(string.Join("-", columnList))")).ToList().ToDictionary(u => $"@(string.Join("-", columnList))", u => u.@(valueColumn));
                        @:pageItems.ForEach(e => e.@(column.PropertyName) = @(column.LowerPropertyName)LinkMap?.GetValueOrDefault(e.@(column.PropertyName)Label, default));
                    @:}
                    }

                    @:
                    @:// æ ¡éªŒå¹¶è¿‡æ»¤å¿…å¡«åŸºæœ¬ç±»å‹ä¸ºnullçš„å­—æ®µ
                    @:var rows = pageItems.Where(x => {
                        foreach (var column in importFields.Where(x => x.WhetherRequired == "Y" && Regex.IsMatch(x.NetType, "(int|long|double|float|bool|Enum[?]?)"))){
                        @:if (x.@(column.PropertyName) == null){
                            @:x.Error = "@(column.ColumnComment)ä¸èƒ½ä¸ºç©º";
                            @:return false;
                        @:}
                        }
                        @:return true;
                    @:}).Adapt<List<@(Model.ClassName)>>();

                    if (dictTableField.Any()) {
                    @:
                    @:// æ˜ å°„å­—å…¸å€¼
                    @:foreach(var row in rows) {
                        foreach (var column in dictTableField){
                        @:row.@(column.PropertyName) = @(column.LowerPropertyName)DictMap.GetValueOrDefault(row.@(column.PropertyName) ?? "");
                        }
                    @:}
                    }

                    @:
                    @:var storageable = _@(Model.LowerClassName)Rep.Context.Storageable(rows)
                        foreach (var column in importFields){
                        if (column.WhetherRequired == "Y"){
                        if(column.NetType.TrimEnd('?') == "string"){
                        @:.SplitError(it => string.IsNullOrWhiteSpace(it.Item.@(column.PropertyName)), "@(column.ColumnComment)ä¸èƒ½ä¸ºç©º")
                        } else if(column.NetType.EndsWith('?') == true){
                        @:.SplitError(it => it.Item.@(column.PropertyName) == null, "@(column.ColumnComment)ä¸èƒ½ä¸ºç©º")
                        }}
                        if (column.NetType?.TrimEnd('?') == "string"){
                        @:.SplitError(it => it.Item.@(column.PropertyName)?.Length > @(column.ColumnLength), "@(column.ColumnComment)é•¿åº¦ä¸èƒ½è¶…è¿‡@(column.ColumnLength)ä¸ªå­—ç¬¦")
                        }}
                        @:.SplitError(it => it.Any(), "è®°å½•å·²å­˜åœ¨")
                        @:.SplitInsert(_ => true)
                        @:.ToStorage();

                    @:
                    @:storageable.BulkCopy();
                    @:storageable.BulkUpdate();
                    @:
                    @:// æ ‡è®°é”™è¯¯ä¿¡æ¯
                    @:markerErrorAction.Invoke(storageable, pageItems, rows);
                @:});
            @:});
@:
            @:return stream;
        @:}
    @:}
}
@}
